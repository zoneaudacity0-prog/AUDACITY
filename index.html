<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Bank Statement Analyzer Dashboard</title>
<style>
* { margin: 0; padding: 0; box-sizing: border-box; font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif; }
body { display: flex; min-height: 100vh; background: #f4f6f8; }

.sidebar { width: 250px; background: #1e1e2f; color: #fff; display: flex; flex-direction: column; padding: 20px; }
.sidebar h2 { margin-bottom: 40px; font-size: 24px; }
.nav-link { padding: 15px 20px; margin-bottom: 10px; background: #2c2c3e; border-radius: 8px; cursor: pointer; transition: background 0.3s; }
.nav-link:hover, .nav-link.active { background: #4b4b6b; }

.main { flex: 1; padding: 30px; overflow-y: auto; }
.module { display: none; background: #fff; padding: 30px; border-radius: 12px; box-shadow: 0 2px 10px rgba(0,0,0,0.1); }
.module.active { display: block; }

#drop-zone { border: 2px dashed #ccc; border-radius: 12px; padding: 40px; text-align: center; color: #666; margin-bottom: 20px; cursor: pointer; transition: background 0.3s; }
#drop-zone.hover { background: #f0f0f0; }

table { width: 100%; border-collapse: collapse; margin-top: 20px; font-size: 16px; }
table th, table td { border: 1px solid #ddd; padding: 12px; text-align: center; }
table th { background: #f4f6f8; font-weight: 600; }
.grand-total, .average { font-weight: bold; background: #e0e0e0; }

button { padding: 12px 20px; border: none; background: #1e1e2f; color: #fff; border-radius: 8px; cursor: pointer; margin-top: 10px; transition: background 0.3s; }
button:hover { background: #4b4b6b; }

@media (max-width: 768px) {
  body { flex-direction: column; }
  .sidebar { width: 100%; flex-direction: row; overflow-x: auto; }
  .sidebar h2 { display: none; }
  .nav-link { flex: 1; margin: 5px; text-align: center; }
  .main { padding: 20px; }
}
</style>
</head>
<body>
<div class="sidebar">
  <h2>Dashboard</h2>
  <div class="nav-link active" data-target="moduleA">OCR Upload</div>
  <div class="nav-link" data-target="moduleB">AI Arrears Interpretation</div>
  <div class="nav-link" data-target="moduleC">Report Generator</div>
</div>

<div class="main">
  <div id="moduleA" class="module active">
    <h1>OCR Upload</h1>
    <div id="drop-zone">Drag & Drop Excel or PDF here, or click to select file</div>
    <input type="file" id="fileInput" accept=".xlsx,.xls,.pdf" style="display:none" />
    <button id="analyzeBtn">Analyze Bank Statement</button>
    <div id="summaryContainer"></div>
  </div>

  <div id="moduleB" class="module">
    <h1>AI Arrears Interpretation</h1>
    <p>Analysis of arrears will appear here.</p>
  </div>

  <div id="moduleC" class="module">
    <h1>Report Generator</h1>
    <p>Reports generated from analyzed data.</p>
  </div>
</div>

<script src="https://cdn.jsdelivr.net/npm/xlsx/dist/xlsx.full.min.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/pdf.js/3.8.162/pdf.min.js"></script>
<script>
const links = document.querySelectorAll('.nav-link');
const modules = document.querySelectorAll('.module');
links.forEach(link => {
  link.addEventListener('click', () => {
    links.forEach(l => l.classList.remove('active'));
    modules.forEach(m => m.classList.remove('active'));
    link.classList.add('active');
    document.getElementById(link.dataset.target).classList.add('active');
  });
});

const dropZone = document.getElementById('drop-zone');
const fileInput = document.getElementById('fileInput');
let uploadedFile = null;

dropZone.addEventListener('click', () => fileInput.click());
fileInput.addEventListener('change', e => uploadedFile = e.target.files[0]);
dropZone.addEventListener('dragover', e => { e.preventDefault(); dropZone.classList.add('hover'); });
dropZone.addEventListener('dragleave', e => { dropZone.classList.remove('hover'); });
dropZone.addEventListener('drop', e => {
  e.preventDefault();
  dropZone.classList.remove('hover');
  uploadedFile = e.dataTransfer.files[0];
  alert(`File uploaded: ${uploadedFile.name}`);
});

document.getElementById('analyzeBtn').addEventListener('click', async () => {
  if (!uploadedFile) return alert('Please upload a file first.');
  const summaryContainer = document.getElementById('summaryContainer');
  summaryContainer.innerHTML = 'Analyzing...';

  if (uploadedFile.name.endsWith('.xlsx') || uploadedFile.name.endsWith('.xls')) {
    const reader = new FileReader();
    reader.onload = e => {
      const data = new Uint8Array(e.target.result);
      const workbook = XLSX.read(data, { type: 'array' });
      const firstSheet = workbook.Sheets[workbook.SheetNames[0]];
      const jsonData = XLSX.utils.sheet_to_json(firstSheet, { header: 1 });
      generateSummaryTable(jsonData);
    };
    reader.readAsArrayBuffer(uploadedFile);
  } else if (uploadedFile.name.endsWith('.pdf')) {
    const pdfData = await uploadedFile.arrayBuffer();
    const pdf = await pdfjsLib.getDocument({ data: pdfData }).promise;
    let fullText = '';
    for(let i=1; i<=pdf.numPages; i++) {
      const page = await pdf.getPage(i);
      const textContent = await page.getTextContent();
      fullText += textContent.items.map(t => t.str).join(' ') + '\n';
    }
    simulatePDFAnalysis(fullText);
  }
});

function generateSummaryTable(data) {
  const summaryContainer = document.getElementById('summaryContainer');
  summaryContainer.innerHTML = '';

  const monthlyData = {};
  data.slice(1).forEach(row => {
    const month = row[1] || `Unknown`;
    const debit = parseFloat((row[2] || 0).toString().replace(/,/g,'')) || 0;
    const credit = parseFloat((row[3] || 0).toString().replace(/,/g,'')) || 0;
    if (!monthlyData[month]) monthlyData[month] = { debit: 0, credit: 0 };
    monthlyData[month].debit += debit;
    monthlyData[month].credit += credit;
  });

  const table = document.createElement('table');
  const header = table.insertRow();
  ['S/N','Month','Debit','Credit'].forEach(h => header.insertCell().textContent = h);

  let grandDebit = 0, grandCredit = 0;
  let sn = 1;
  const sortedMonths = Object.keys(monthlyData).sort((a,b)=> new Date(a) - new Date(b)); // Optional sorting
  sortedMonths.forEach(month => {
    const r = table.insertRow();
    const { debit, credit } = monthlyData[month];
    grandDebit += debit;
    grandCredit += credit;
    [sn++, month, debit.toLocaleString(), credit.toLocaleString()].forEach(v => r.insertCell().textContent = v);
  });

  // Total row
  const totalRow = table.insertRow();
  totalRow.classList.add('grand-total');
  ['','Total', grandDebit.toLocaleString(), grandCredit.toLocaleString()].forEach(v => totalRow.insertCell().textContent = v);

  // Average row
  const avgRow = table.insertRow();
  avgRow.classList.add('average');
  const monthCount = Object.keys(monthlyData).length;
  ['','Average', (grandDebit/monthCount).toLocaleString(), (grandCredit/monthCount).toLocaleString()].forEach(v => avgRow.insertCell().textContent = v);

  // Header for bank & school (optional)
  const titleDiv = document.createElement('div');
  titleDiv.innerHTML = `<h2>CASH FLOW SUMMARY - CRDB BANK</h2><h3>PREMIER GIRLS SEC SCHOOL 2024-2025</h3>`;
  summaryContainer.appendChild(titleDiv);
  summaryContainer.appendChild(table);
}

function simulatePDFAnalysis(text) {
  // Basic PDF text simulation: detect lines with Month + Debit + Credit
  const lines = text.split('\n').filter(l => l.trim());
  const data = [['S/N','Month','Debit','Credit']];
  lines.forEach((line, idx) => {
    const parts = line.match(/([A-Za-z]{3,}-\d{2,4})\s?([\d,\.]+)?\s?([\d,\.]+)?/);
    if (parts) {
      const month = parts[1] || `Month ${idx+1}`;
      const debit = parseFloat((parts[2] || 0).replace(/,/g,'')) || 0;
      const credit = parseFloat((parts[3] || 0).replace(/,/g,'')) || 0;
      data.push([idx+1, month, debit, credit]);
    }
  });
  generateSummaryTable(data);
}
</script>
</body>
</html>
