<!doctype html>
<html lang="en">
<head>
<meta charset="utf-8"/>
<meta name="viewport" content="width=device-width, initial-scale=1"/>
<title>Audacity Zone â€” Financial & Ledger Intelligence Engine</title>

<!-- Libraries -->
<script src="https://cdnjs.cloudflare.com/ajax/libs/PapaParse/5.4.1/papaparse.min.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.full.min.js"></script>
<script src="https://cdn.jsdelivr.net/npm/chart.js"></script>

<style>
    body { font-family: Arial, sans-serif; margin:0; padding:0; background:#f5f7fb; }
    header { background:#fff; padding:20px 40px; display:flex; justify-content:space-between; 
             position:sticky; top:0; box-shadow:0 2px 10px rgba(0,0,0,0.08); }
    h2 { margin-top:40px; }
    .container { padding:40px; }
    .box { padding:20px; background:white; border-radius:10px; box-shadow:0 3px 15px rgba(0,0,0,0.07); margin-top:25px; }
    .upload-area { border:2px dashed #0a84ff; padding:40px; text-align:center; border-radius:12px; cursor:pointer; background:#eef6ff; }
    .btn { padding:12px 22px; background:#0a84ff; color:white; border:none; border-radius:8px; cursor:pointer; font-size:16px; }
    table { width:100%; border-collapse:collapse; margin-top:20px; }
    table th, table td { border:1px solid #ddd; padding:10px; text-align:center; }
    table th { background:#f0f0f0; }
    .summary { margin-top:20px; padding:20px; background:#e8f3ff; border-radius:10px; }
</style>
</head>

<body>

<header>
    <div style="font-size:24px; font-weight:700;">Audacity Zone</div>
</header>

<div class="container">

<!-- LEDGER ANALYZER MODULE -->
<h2>Loan Ledger Analysis â€” Financial Intelligence Engine</h2>
<div class="box">
    <label><strong>Client Ledger Name / Reference ID</strong></label><br>
    <input id="ledgerName" type="text" placeholder="e.g. John Doe Ledger 2024" style="width:100%; padding:12px; margin-top:10px;">

    <div id="ledgerUpload" class="upload-area" style="margin-top:20px;">
        <strong>Drop Ledger File or Click to Upload</strong><br>
        <small>Upload Ledger (.csv, .xlsx)</small>
    </div>

    <button class="btn" style="margin-top:20px;" onclick="analyzeLedger()">Analyze Ledger</button>

    <div id="ledgerOutput"></div>
</div>

<!-- MONTHLY STATEMENT ANALYZER (From previous work) -->
<h2 style="margin-top:60px;">Bank Statement Monthly Summary</h2>
<div class="box">
    <label><strong>Statement Name / Reference</strong></label><br>
    <input id="statementName" type="text" placeholder="MBEZI SCHOOL STATEMENT" style="width:100%; padding:12px; margin-top:10px;">

    <div id="statementUpload" class="upload-area" style="margin-top:20px;">
        <strong>Upload Bank Statement</strong><br>
        <small>Supported: .csv, .xlsx</small>
    </div>

    <button class="btn" style="margin-top:20px;" onclick="analyzeStatement()">Analyze Statement</button>

    <div id="statementOutput"></div>
</div>

</div>

<script>
// GLOBAL VARIABLES
let ledgerFileData = null;
let statementFileData = null;

// UPLOAD HANDLERS
document.getElementById("ledgerUpload").onclick = () => uploadLedger();
document.getElementById("statementUpload").onclick = () => uploadStatement();

function uploadLedger() { chooseFile(f => ledgerFileData = f); }
function uploadStatement() { chooseFile(f => statementFileData = f); }

function chooseFile(callback){
    let input = document.createElement("input");
    input.type = "file";
    input.accept = ".csv,.xlsx";
    input.onchange = e => callback(e.target.files[0]);
    input.click();
}

// PARSE CSV OR EXCEL
function parseFile(file, callback){
    let name = file.name.toLowerCase();

    if(name.endsWith(".csv")){
        Papa.parse(file, {
            header: true,
            complete: res => callback(res.data)
        });
    } 
    else if(name.endsWith(".xlsx")){
        let reader = new FileReader();
        reader.onload = e => {
            let workbook = XLSX.read(e.target.result, { type: "binary" });
            let sheet = workbook.Sheets[workbook.SheetNames[0]];
            callback(XLSX.utils.sheet_to_json(sheet));
        };
        reader.readAsBinaryString(file);
    }
}

// LEDGER ANALYSIS ENGINE
function analyzeLedger(){
    if(!ledgerFileData){ alert("Upload a ledger!"); return; }

    parseFile(ledgerFileData, rows => {

        let totalPrincipalPaid = 0;
        let totalInterestPaid = 0;
        let totalPenalty = 0;
        let expectedTotal = 0;
        let actualTotal = 0;

        rows.forEach(r => {
            totalPrincipalPaid += Number(r.PrincipalPaid || 0);
            totalInterestPaid += Number(r.InterestPaid || 0);
            totalPenalty += Number(r.Penalty || 0);
            expectedTotal += Number(r.ExpectedPayment || 0);
            actualTotal += Number(r.ActualPayment || 0);
        });

        let arrears = expectedTotal - actualTotal;
        let daysInArrears = arrears > 0 ? Math.floor(arrears / 10000) * 30 : 0; 
        let defaultInterest = arrears * 0.03;

        let rating = interpretClient(arrears, daysInArrears);

        document.getElementById("ledgerOutput").innerHTML = `
            <div class='summary'>
                <h3>Ledger Summary for: ${document.getElementById("ledgerName").value}</h3>

                <table>
                    <tr><th>Total Principal Paid</th><td>${totalPrincipalPaid.toFixed(2)}</td></tr>
                    <tr><th>Total Interest Paid</th><td>${totalInterestPaid.toFixed(2)}</td></tr>
                    <tr><th>Total Penalties</th><td>${totalPenalty.toFixed(2)}</td></tr>
                    <tr><th>Expected Payments</th><td>${expectedTotal.toFixed(2)}</td></tr>
                    <tr><th>Actual Payments</th><td>${actualTotal.toFixed(2)}</td></tr>
                    <tr><th>Total Arrears</th><td>${arrears.toFixed(2)}</td></tr>
                    <tr><th>Days in Arrears</th><td>${daysInArrears}</td></tr>
                    <tr><th>Default Interest</th><td>${defaultInterest.toFixed(2)}</td></tr>
                </table>

                <h3>Client Behavior Assessment</h3>
                <p><strong>${rating}</strong></p>
            </div>
        `;
    });
}

// AI-LIKE INTERPRETATION ENGINE
function interpretClient(arrears, days){
    if(arrears <= 0) return "ðŸ“— Fully Performing â€” No arrears detected.";
    if(days < 30) return "ðŸ“˜ Slight Delay â€” Minor missed installment.";
    if(days < 90) return "ðŸ“™ Moderate Risk â€” Arrears increasing.";
    if(days < 180) return "ðŸ“• High Risk â€” Severe arrears, loan deteriorating.";
    return "ðŸš¨ Critical â€” Default risk extremely high.";
}

// STATEMENT MONTHLY SUMMARY ENGINE
function analyzeStatement(){
    if(!statementFileData){ alert("Upload a statement first"); return; }

    parseFile(statementFileData, rows => {
        let summary = {};

        rows.forEach(r => {
            let date = new Date(r.Date || r.DATE || r.date);
            if(isNaN(date)) return;

            let monthKey = date.getFullYear() + "-" + (date.getMonth() + 1);
            if(!summary[monthKey]) summary[monthKey] = { debit:0, credit:0 };

            summary[monthKey].debit += Number(r.Debit || r.debit || 0);
            summary[monthKey].credit += Number(r.Credit || r.credit || 0);
        });

        let html = "<table><tr><th>Month</th><th>Total Debit</th><th>Total Credit</th></tr>";

        Object.keys(summary).forEach(m => {
            html += `<tr><td>${m}</td><td>${summary[m].debit.toFixed(2)}</td><td>${summary[m].credit.toFixed(2)}</td></tr>`;
        });

        html += "</table>";
        document.getElementById("statementOutput").innerHTML = html;
    });
}
</script>

</body>
</html>
