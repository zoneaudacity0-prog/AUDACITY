const isoDate = parsedDate ? parsedDate.toISOString().slice(0,10) : '';

const desc = (r.Description || r.Details || '').toString().trim();

const debit = parseFloat(r.Debit || r.debit || r['Debit Amount'] || 0) || 0;
const credit = parseFloat(r.Credit || r.credit || r['Credit Amount'] || 0) || 0;

normalized.push({
  Date: isoDate,
  Description: desc,
  Debit: debit,
  Credit: credit
});
}

return normalized;
}

/* Flexible date parser */
function parseFlexibleDate(val){
if (!val) return null;
let v = String(val).trim();

if (/^\d{4}[-/]\d{2}[-/]\d{2}$/.test(v)) return new Date(v);

if (/^\d{1,2}[-/]\d{1,2}[-/]\d{4}$/.test(v)) {
  const [a,b,c] = v.split(/[-/]/);
  return new Date(`${c}-${a.padStart(2,'0')}-${b.padStart(2,'0')}`);
}

return null;
}

/* ----- Monthly summary builder ----- */
function buildMonthlySummary(rows){
const map = {};
rows.forEach(r=>{
  if (!r.Date) return;
  const month = r.Date.slice(0,7);  // YYYY-MM
  if (!map[month]) map[month] = { Debit:0, Credit:0 };
  map[month].Debit += r.Debit||0;
  map[month].Credit += r.Credit||0;
});
return map;
}

/* ----- Build HTML summary table ----- */
function renderSummaryTable(summary){
let html = `
<table class="min-w-full border text-sm">
<thead class="bg-slate-100">
<tr>
<th class="border px-2 py-1">Month</th>
<th class="border px-2 py-1">Debit</th>
<th class="border px-2 py-1">Credit</th>
</tr>
</thead><tbody>
`;

Object.keys(summary).sort().forEach(m=>{
  html += `
    <tr>
      <td class="border px-2 py-1">${m}</td>
      <td class="border px-2 py-1">${summary[m].Debit.toLocaleString()}</td>
      <td class="border px-2 py-1">${summary[m].Credit.toLocaleString()}</td>
    </tr>
  `;
});
html += `</tbody></table>`;
return html;
}

/* ---------- Analyze Button ---------- */
document.getElementById('analyzeBtn').addEventListener('click', async ()=>{
if (uploadedFiles.length===0){
  alert('Upload at least one statement.');
  return;
}

const stmtRef = document.getElementById('stmtRef').value.trim() || 'REF-' + Date.now();
const allRows = [];
let ocrTextCollected = '';

for (let f of uploadedFiles){
  const parsed = await parseFileToRows(f);
  if (parsed.rows) allRows.push(...parsed.rows);
  if (parsed.ocrText) ocrTextCollected += '\n' + parsed.ocrText;
}

const normalized = normalizeRows(allRows);
const summary = buildMonthlySummary(normalized);

const analysisObj = {
  ref: stmtRef,
  files: uploadedFiles.map(f=>f.name),
  rows: normalized,
  summary,
  ocrText: ocrTextCollected,
  timestamp: new Date().toISOString()
};

analyses = [analysisObj];

document.getElementById('resultTitle').textContent = `Analysis Results — ${stmtRef}`;
document.getElementById('resultMeta').textContent = `Ref: ${stmtRef} • Files: ${uploadedFiles.length}`;

// summary table
document.getElementById('summaryTableWrap').innerHTML = renderSummaryTable(summary);

// show results
document.getElementById('resultsCard').classList.remove('hidden');
document.getElementById('noResults').style.display = 'none';

populateHistory();

// Populate AI dropdown
populateAnalysisSelect();
});

/* ---------- Save Analysis History ---------- */
function populateHistory(){
if (!document.getElementById('storeHistory').checked) return;

let saved = JSON.parse(localStorage.getItem(LS_HISTORY)||'[]');
saved.push(analyses[0]);
localStorage.setItem(LS_HISTORY, JSON.stringify(saved));

renderHistory();
}

function renderHistory(){
const saved = JSON.parse(localStorage.getItem(LS_HISTORY)||'[]');
if (saved.length===0){
  document.getElementById('historyList').textContent = 'No saved analyses.';
  return;
}
let html = '';
saved.forEach((a,i)=>{
  html += `
  <div class="border-b py-1">
    <strong>${i+1}. ${a.ref}</strong>
    <div class="text-xs text-slate-500">${a.timestamp}</div>
  </div>`;
});
document.getElementById('historyList').innerHTML = html;
}

document.getElementById('clearHistoryBtn').addEventListener('click', ()=>{
localStorage.removeItem(LS_HISTORY);
renderHistory();
});

/* ---------- AI INTERPRETATION MODULE ---------- */
function populateAnalysisSelect(){
const sel = document.getElementById('analysisSelect');
sel.innerHTML = '';
if (analyses.length===0) return;

analyses.forEach((a,i)=>{
  const opt = document.createElement('option');
  opt.value = i;
  opt.textContent = `${a.ref} — ${a.rows.length} rows`;
  sel.appendChild(opt);
});
}

document.getElementById('runInterpretBtn').addEventListener('click', ()=>{
const sel = document.getElementById('analysisSelect');
if (!sel.value){
  alert('No analysis selected.');
  return;
}
const a = analyses[sel.value];
const out = interpretHeuristic(a.rows);
document.getElementById('interpretOutput').textContent = out;
});

/* Simple arrears logic */
function interpretHeuristic(rows){
let debitSum = 0;
let creditSum = 0;

rows.forEach(r=>{
  debitSum += r.Debit||0;
  creditSum += r.Credit||0;
});

let balance = creditSum - debitSum;
let status = balance < 0 ? 'Possible arrears' : 'Likely up to date';

return `
Total Debit: ${debitSum.toLocaleString()}
Total Credit: ${creditSum.toLocaleString()}

Balance: ${balance.toLocaleString()}
Status: ${status}
`;
}

/* ---------- Report Module ---------- */
document.getElementById('downloadSummaryBtn')
  .addEventListener('click', ()=> exportSummaryExcel());

document.getElementById('downloadDetailedBtn')
  .addEventListener('click', ()=> exportDetailedExcel());

function exportSummaryExcel(){
if (analyses.length===0) return alert('No analysis.');
const a = analyses[0];
const ws = XLSX.utils.json_to_sheet(
  Object.keys(a.summary).map(m=>({
    Month: m,
    Debit: a.summary[m].Debit,
    Credit: a.summary[m].Credit
  }))
);
const wb = XLSX.utils.book_new();
XLSX.utils.book_append_sheet(wb, ws, 'Summary');
XLSX.writeFile(wb, `Summary-${a.ref}.xlsx`);
}

function exportDetailedExcel(){
if (analyses.length===0) return alert('No analysis.');
const a = analyses[0];
const ws = XLSX.utils.json_to_sheet(a.rows);
const wb = XLSX.utils.book_new();
XLSX.utils.book_append_sheet(wb, ws, 'Detailed');
XLSX.writeFile(wb, `Detailed-${a.ref}.xlsx`);
}
</script>
