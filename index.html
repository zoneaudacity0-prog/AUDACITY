<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Bank Statement Monthly Summary</title>
<style>
body { font-family: Arial, sans-serif; background: #f4f6f8; margin: 0; padding: 20px; }
.container { max-width: 1000px; margin: auto; background: #fff; padding: 20px; border-radius: 8px; box-shadow: 0 6px 20px rgba(0,0,0,0.1);}
h1, h2 { text-align: center; }
input, button { padding: 8px; margin-right: 10px; border-radius: 5px; border: 1px solid #ccc; }
button { cursor: pointer; background: #2563eb; color: white; border: none; }
button:hover { background: #1e40af; }
table { width: 100%; border-collapse: collapse; margin-top: 20px; }
th, td { border: 1px solid #ddd; padding: 10px; text-align: right; }
th:first-child, td:first-child { text-align: center; }
th { background: #1f2937; color: white; }
tfoot td { font-weight: bold; background: #f3f4f6; }
#download { display: none; }
</style>
<script src="https://cdn.jsdelivr.net/npm/xlsx@0.18.5/dist/xlsx.full.min.js"></script>
<script src="https://cdn.jsdelivr.net/npm/papaparse@5.4.1/papaparse.min.js"></script>
</head>
<body>
<div class="container">
<h1>CRDB Bank Monthly Cash Flow Summary</h1>
<input type="file" id="fileInput" accept=".csv,.xls,.xlsx">
<button id="processBtn">Process Statement</button>
<button id="download">Download CSV</button>
<h2 id="accountName"></h2>
<div id="tableContainer"></div>
</div>

<script>
function normalizeNumber(val){
    if(!val) return 0;
    let str = String(val).replace(/,/g,'').replace(/\s/g,'').trim();
    if(str === '') return 0;
    const n = parseFloat(str);
    return isNaN(n)?0:n;
}

function monthKey(dateStr){
    if(!dateStr) return null;
    const d = new Date(dateStr);
    if(!isNaN(d)) return `${d.getFullYear()}-${String(d.getMonth()+1).padStart(2,'0')}`;
    return null;
}

document.getElementById('processBtn').addEventListener('click', async ()=>{
    const file = document.getElementById('fileInput').files[0];
    if(!file){ alert("Please upload a bank statement file."); return; }

    let rows=[], headers=[];
    const name = file.name.toLowerCase();
    if(name.endsWith('.csv')){
        const text = await file.text();
        const parsed = Papa.parse(text, {header:true, skipEmptyLines:true});
        rows = parsed.data;
        headers = parsed.meta.fields;
    } else {
        const data = await file.arrayBuffer();
        const workbook = XLSX.read(data,{type:'array'});
        const sheet = workbook.Sheets[workbook.SheetNames[0]];
        rows = XLSX.utils.sheet_to_json(sheet,{defval:""});
        headers = rows[0]?Object.keys(rows[0]):[];
    }

    // Detect Account Name
    let accountName = "Unknown Account";
    for(const r of rows){
        for(const key in r){
            if(r[key].toString().toLowerCase().includes("account name")){
                accountName = r[key] || "Unknown Account";
            }
        }
    }
    document.getElementById('accountName').textContent = accountName;

    // Detect debit, credit, date columns
    const dateKey = headers.find(h=>/date/i.test(h) && /trans|value/i.test(h));
    const debitKey = headers.find(h=>/debit|dr/i.test(h));
    const creditKey = headers.find(h=>/credit|cr/i.test(h));

    if(!dateKey || !debitKey || !creditKey){
        alert("Could not detect Date, Debit, or Credit columns. Check file format.");
        return;
    }

    const monthly = {};
    for(const r of rows){
        const m = monthKey(r[dateKey]);
        if(!m) continue;
        const debit = normalizeNumber(r[debitKey]);
        const credit = normalizeNumber(r[creditKey]);
        if(!monthly[m]) monthly[m] = {debit:0, credit:0};
        monthly[m].debit += debit;
        monthly[m].credit += credit;
    }

    const sortedMonths = Object.keys(monthly).sort();
    let html = `<table><thead><tr><th>S/N</th><th>Month</th><th>Total Debit</th><th>Total Credit</th></tr></thead><tbody>`;
    let totalDebit = 0, totalCredit = 0;
    const csvRows = [["Month","Total Debit","Total Credit"]];
    sortedMonths.forEach((m,i)=>{
        const d = monthly[m].debit;
        const c = monthly[m].credit;
        html += `<tr><td>${i+1}</td><td>${m}</td><td>${d.toLocaleString(undefined,{minimumFractionDigits:2,maximumFractionDigits:2})}</td><td>${c.toLocaleString(undefined,{minimumFractionDigits:2,maximumFractionDigits:2})}</td></tr>`;
        totalDebit += d;
        totalCredit += c;
        csvRows.push([m,d.toFixed(2),c.toFixed(2)]);
    });
    html += `</tbody><tfoot><tr><td colspan="2">TOTAL</td><td>${totalDebit.toLocaleString(undefined,{minimumFractionDigits:2,maximumFractionDigits:2})}</td><td>${totalCredit.toLocaleString(undefined,{minimumFractionDigits:2,maximumFractionDigits:2})}</td></tr>`;
    html += `<tr><td colspan="2">AVERAGE</td><td>${(totalDebit/sortedMonths.length).toLocaleString(undefined,{minimumFractionDigits:2,maximumFractionDigits:2})}</td><td>${(totalCredit/sortedMonths.length).toLocaleString(undefined,{minimumFractionDigits:2,maximumFractionDigits:2})}</td></tr></tfoot></table>`;
    document.getElementById('tableContainer').innerHTML = html;

    // CSV download
    const csvContent = csvRows.map(r=>r.join(',')).join('\n');
    const blob = new Blob([csvContent],{type:'text/csv;charset=utf-8;'});
    const blobUrl = URL.createObjectURL(blob);
    const downloadBtn = document.getElementById('download');
    downloadBtn.style.display = 'inline-block';
    downloadBtn.onclick = ()=>{ const a = document.createElement('a'); a.href = blobUrl; a.download = 'monthly-summary.csv'; document.body.appendChild(a); a.click(); a.remove(); };
});
</script>
</body>
</html>
