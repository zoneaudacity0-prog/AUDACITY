<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<title>CASH FLOW SUMMARY - Wolfgang OCR</title>
<meta name="viewport" content="width=device-width, initial-scale=1">
<style>
    body {
        font-family: Arial, sans-serif;
        background: #f4f6f8;
        padding: 40px;
    }
    h2 {
        text-align: center;
        font-weight: 700;
    }
    #uploadBox {
        border: 2px dashed #666;
        padding: 25px;
        text-align: center;
        margin-bottom: 25px;
        border-radius: 10px;
        background: white;
    }
    table {
        width: 100%;
        border-collapse: collapse;
        margin-top: 25px;
        background: white;
    }
    table, th, td {
        border: 1px solid #ccc;
    }
    th, td {
        padding: 12px;
        text-align: center;
    }
    th {
        background: #222;
        color: #fff;
    }
    .btn {
        background: black;
        color: white;
        padding: 10px 20px;
        border-radius: 6px;
        cursor: pointer;
        border: none;
        margin-top: 15px;
    }
</style>
</head>
<body>

<h2>CASH FLOW SUMMARY â€“ Wolfgang Bank Statement Analyzer</h2>

<div id="uploadBox">
    <input type="file" id="fileInput" accept=".csv">
    <br><br>
    <button class="btn" onclick="processFile()">Upload & Generate Summary</button>
</div>

<div id="output"></div>

<script>
function processFile() {
    const file = document.getElementById("fileInput").files[0];
    if (!file) {
        alert("Please upload a CSV bank statement.");
        return;
    }

    const reader = new FileReader();
    reader.onload = function(e) {
        const rows = e.target.result.split("\n").map(r => r.split(","));

        // Detect column indexes
        const headers = rows[0].map(h => h.trim().toLowerCase());
        const dateIdx = headers.indexOf("date");
        const debitIdx = headers.indexOf("debit");
        const creditIdx = headers.indexOf("credit");

        if (dateIdx === -1 || debitIdx === -1 || creditIdx === -1) {
            alert("CSV must contain Date, Debit, Credit columns.");
            return;
        }

        let monthly = {};

        for (let i = 1; i < rows.length; i++) {
            let cols = rows[i];
            if (cols.length < 3) continue;

            let date = new Date(cols[dateIdx]);
            if (isNaN(date)) continue;

            let monthKey = date.toLocaleString("en-US", { month: "short", year: "2-digit" });

            let debit = parseFloat(cols[debitIdx].replace(/,/g, "")) || 0;
            let credit = parseFloat(cols[creditIdx].replace(/,/g, "")) || 0;

            if (!monthly[monthKey]) {
                monthly[monthKey] = { debit: 0, credit: 0 };
            }

            monthly[monthKey].debit += debit;
            monthly[monthKey].credit += credit;
        }

        let months = Object.keys(monthly);

        let totalDebit = 0;
        let totalCredit = 0;

        let table = `
            <table>
                <tr>
                    <th>S/N</th>
                    <th>Month</th>
                    <th>Debit</th>
                    <th>Credit</th>
                </tr>
        `;

        months.forEach((m, i) => {
            let d = monthly[m].debit;
            let c = monthly[m].credit;
            totalDebit += d;
            totalCredit += c;

            table += `
                <tr>
                    <td>${i + 1}</td>
                    <td>${m}</td>
                    <td>${d.toLocaleString()}</td>
                    <td>${c.toLocaleString()}</td>
                </tr>
            `;
        });

        let avgDebit = totalDebit / months.length;
        let avgCredit = totalCredit / months.length;

        table += `
            <tr>
                <th></th>
                <th>Total</th>
                <th>${totalDebit.toLocaleString()}</th>
                <th>${totalCredit.toLocaleString()}</th>
            </tr>
            <tr>
                <th></th>
                <th>Average</th>
                <th>${avgDebit.toLocaleString(undefined,{minimumFractionDigits:2})}</th>
                <th>${avgCredit.toLocaleString(undefined,{minimumFractionDigits:2})}</th>
            </tr>
        </table>
        `;

        document.getElementById("output").innerHTML = table +
        `<button class="btn" onclick="downloadCSV()">Download Summary CSV</button>`;

        window.generatedTable = { monthly, totalDebit, totalCredit, avgDebit, avgCredit };
    };

    reader.readAsText(file);
}

function downloadCSV() {
    let csv = "Month,Debit,Credit\n";
    let { monthly, totalDebit, totalCredit, avgDebit, avgCredit } = window.generatedTable;

    for (let m in monthly) {
        csv += `${m},${monthly[m].debit},${monthly[m].credit}\n`;
    }

    csv += `Total,${totalDebit},${totalCredit}\n`;
    csv += `Average,${avgDebit},${avgCredit}\n`;

    const blob = new Blob([csv], { type: "text/csv" });
    const link = document.createElement("a");
    link.href = URL.createObjectURL(blob);
    link.download = "cash_flow_summary.csv";
    link.click();
}
</script>

</body>
</html>
